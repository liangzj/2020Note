# 缓存设计架构的常见考量点
+ 读写方式： 主要考量在value的读取，是全量读取，还是读取部分，或者读取前进行必要内部运算？
+ KV size
    - 单个业务的KV size过大则分拆
    - 不同量级的KV size不放同节点，避免相互印象
+ key的数量
    - 数量不大，可以全量加载
    - 数量巨大，可只存hot key,冷数据直接db
+ 读写峰值（QPS）
    - 小于10万级别，拆分独立Cache池
    - 大于10万级别， 考虑分层处理，比如Local-Cache+远程cache
+ 命中率
    - 正常场景，核心高并发业务，预留足够容量。
    - 异常情况，考虑故障处理与故障转移方案，比如一致性Hash分布的访问漂移策略 or 数据多层备份策略。
+ 过期策略
    - 较短过期时间，冷key自动过期。
    - key带上时间戳+较长过期时间，比如key_20200202
+ 平均缓存穿透加载时间：时间越长，容量换命中率，效果就越佳。

+ 缓存可运维性：
    + 一键扩缩容
    + 缓存组件升级或变更方案
    + 持续监控告警
    + 集群管理
    + 运维工具或平台集成
+ 缓存安全性
    - 限制来源IP
    - 只允许内网访问等
    - 关键指令再加访问权限

# 缓存设计中的7大经典问题
+ 缓存失效
+ 缓存穿透
+ 缓存雪崩
+ 数据不一致
+ 数据并发竞争
+ Hot key
+ Big key

## 缓存失效：
### 问题描述：  
在某一时刻，大批key同时过期，很多缓存数据访问miss穿透到DB，进而导致请求慢查询率明显上升。
### 原因分析：
主要和写缓存的过期时间相关，在某些场景中，出现批量加载业务数据写入缓存，如果这个时候设置相同过期时间，在经历这个过期时间之后就会同时被淘汰。
### 业务场景：
比如微博业务，会有后台离线系统，持续计算热门微博，每当计算结束，会将这批热门微博批量写入对应的缓存。还比如，很多业务，在部署新 IDC 或新业务上线时，会进行缓存预热，也会一次性加载大批热数据
### 解决方案：
过期时间使用：过期时间=base时间+随机时间。

## 缓存穿透
### 问题描述：
正常访问，数据不在缓存，也可通过DB加载回填，但是某些特殊访客使用DB也不存在的key，如果同时大批量的触发访问这个不存在的key,就会对DB造成压力，从而影响正常服务功能。

### 业务场景：
不存在的UID访问用户，不存在的车次ID查看购票信息等，如果用户输错，偶发性影响不大，但是如果恶意大量请求，则会造成影响。

### 解决方案：
+ 方案一：异常key保存缓存
    - 方案：查DB返回NULL时也记录该key到缓存，对应value用约定的特殊值表示。
    - 缺点： 如果存在大批不合理key，也会占用大量缓存空间资源，同时也导致命中率下降。
    - 改进： 对异常key设置较短超时时间；设置一个独立公共缓存，正常如果miss，再来查公共缓存的非法key缓存，如果是返回，否则穿透DB,如果DB返回空回填非法公共缓存，正常值则回填正常缓存。
+ 方案二： BloomFilter缓存过滤器
    - 方案：构建BloomFilter缓存过滤器（布隆过滤器），记录全量数据，如果BloomFilter判断不存在直接返回，根本不查询缓存和DB.
    - 缺点：缓存全量key，要求数量10亿以内最佳，因为10亿大约需要1.2G内存。
    - 改进：BloomFilter缓存非法的key,并且定期清零处理，规避key太多导致误判率增大。

### BoomFilter的原理：（下步扩展）

## 缓存雪崩问题
### 问题描述：
部分缓存节点不可用，导致整个缓存体系甚至服务系统不可用。主要可分为缓存不支持rehash下导致雪崩与支持rehash情况下导致雪崩。

### 原因分析：
+ 不支持rehash： 一般在较多缓存节点异常时，导致原本的缓存节点访问请求直接直接穿透DB，造成DB过载，大量慢查询，最终阻塞宕机，最终导致服务异常。
+ 支持rehash场景：在流量洪峰时，部分节点因为缓存服务过载最终宕机，又因为rehash扩散到其它缓存节点，最终导致整个缓存体系故障。

### 业务场景：
+ 部分缓存服务机器断电，导致业务缓存多个节点宕机~
+ 业务突发超过业务系统承载力的流量洪峰，导致部分节点宕机~

### 解决方案：
+ 方案一： 业务DB访问加读写开关，在发现DB慢请求或阻塞时，且慢请求超过阈值时，关闭读开关，请求直接failfast返回，待DB恢复再打开。
+ 方案二：增加多个副本，且尽量将各个副本保存在不同机架或机器上，保障机器故障或节点异常时，直接使用缓存副本节点，保证缓存服务正常。
+ 方案三：缓存进行实时监控，当请求慢速比超过阈值或部分节点故障时，及时告警，通过机器替换、服务替换及时恢复；设置各种自动故障策略，自动关闭异常接口、停止边缘服务、停止非核心服务，确保最终核心功能的正常运行。



